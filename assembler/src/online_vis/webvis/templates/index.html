<!doctype html>
<html>
<head>
  <title>WebVis</title>
  <link rel="stylesheet" href="static/jquery-ui.min.css">
  <link rel="stylesheet" href="static/themes/default/style.min.css">
  <style>
  div.console { font-size:14px; font-family:monospace }
  div.console div.jquery-console-inner
  { width:100%; height:640px; padding:0.5em; overflow:auto }
  /*div.console div.jquery-console-prompt-box
  { color:#fff; }*/
  div.console div.jquery-console-focus span.jquery-console-cursor
  { background:#111; color:#333; font-weight:bold }
  div.console span.jquery-console-prompt-label { font-weight:bold }
  div#graph {max-width:800px; height:640px; margin:auto}
  input#command {width:100%}
  iframe {width:100%; height:640px; overflow:scroll}
  </style>
  <!--Basic interaction plugins-->
  <script type="text/javascript" src="static/jquery.js"></script>
  <script type="text/javascript" src="static/center-loader.min.js"></script>
  <script type="text/javascript" src="static/jquery.console.js"></script>
  <!--Local stuff-->
  <script type="text/javascript">
//Commands autocomplete
//TODO: get commands from help
var standardCommands = ["batch", "clear_pos", "clip_tips", "draw_connected", "draw_contig",
  "draw_contigs", "draw_edge", "draw_part_of_genome", "draw_polymorphic", "draw_poorly_assembled",
  "draw_position", "draw_unresolved_wrt_assembly", "draw_unresolved_wrt_reference", "draw_vertex",
  "exit", "fill_pos", "help", "junction_sequence", "list", "load", "load_genome", "log",
  "print_contigs_stats", "print_edge", "print_paths", "replay", "save", "set_file_name",
  "set_folder", "set_max_vertices", "show_position", "switch_env"
]

function startWheel(where) {
  $(where).loader("show", "<img src=\"static/assets/wheel.gif\">");
}

function stopWheel(where) {
  $(where).loader("hide");
}

function sendCommand(command, callback) {
  startWheel("#console_container");
  $.ajax({
    url: "command",
    type: "GET",
    data: {command: command},
    success: function(response) {
      stopWheel("#console_container");
      callback(response);
    }
  });
}

function drawVertex(id) {
  $(function() {
    $("#graph").html($("<iframe>").attr("src", "/vertex/" + id));
  });
}

var specialFunctions = {
  "draw_vertex": drawVertex
}

var initLog;
$.ajax({
  url: "/log",
  async: false,
  success: function(response) {
    initLog = response;
  }
});

$(function() {
  var controller = $(".console").console({
    promptLabel: "GAF$> ",
    welcomeMessage: initLog,
    commandValidate: function(line) {
      return (line != "");
    },
    commandHandle: function(line) {
      sendCommand(line, function getLog(response) {
        $(function() {
          controller.report(response.log);
          if (!response.complete)
          sendCommand("", getLog);
        });
      });
      return true;
    },
    animateScroll: true,
    promptHistory: true,
    completeHandle: function(prefix) {
      var ret = [];
      standardCommands.forEach(function(command) {
        if (command.lastIndexOf(prefix, 0) === 0) {
          ret.push(command.substring(prefix.length));
        }
      });
      return ret;
    }
  });

  var dynamicGraph = false;

  //Clicking on .dot files loads them as an svg
  $(".console").on("click", "[href$='.dot']", function(event) {
    event.preventDefault();
    var url = $(this).attr("href");
    if (dynamicGraph) {
      updateDynamicGraph(url);
    } else {
      startWheel("#graph");
      $.ajax({
        url: url,
        success: function (response) {
          stopWheel("#graph");
          $("#graph").html($("<iframe>").attr("src", response));
        }
      });
    }
  });

  $(".console").on("click", "[href$='/']", function(event) {
    event.preventDefault();
    var url = $(this).attr("href");
    $.ajax({
      url: url,
      success: function (response) {
        $(function () {controller.report(response);});
      }
    });
  });
});
</script>
</head>

<body>
  <table width="100%"><tr height="100%">
    <td width="50%" id="console_container">
      <table>
        <tr>
          <td width=100%>Welcome to WebVis, {{username}}</td>
          <td><a href="logout">Logout</a></td>
        </tr>
      </table>
      <div class="console"></div>
    </td>
    <td id="graph" width="50%">
      <!--The rendered graph will be displayed here-->
    </td>
  </tr></table>
</body>
</html>
